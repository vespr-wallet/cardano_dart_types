import "package:cardano_dart_types/cardano_dart_types.dart";
import "package:test/test.dart";

void main() async {
  group("CardanoTransactionBody", () {
    group("parsing", () {
      test("intputs cbor tags", () async {
        final txBody = [
          "a400d90102818258203b40265111d8bb3c3c608d95b3a0bf83461ace32d79336579a1939b3aad1c0b700018002182a030a",
          "a400818258203b40265111d8bb3c3c608d95b3a0bf83461ace32d79336579a1939b3aad1c0b700018002182a030a",
        ];

        final txWithTags = CardanoTransactionBody.deserializeHex(txBody[0]);
        final txWithoutTags = CardanoTransactionBody.deserializeHex(txBody[1]);

        expect(txWithTags.inputs.cborTags, [258]);
        expect(txWithoutTags.inputs.cborTags, []);
      });
      test("hex", () async {
        const input =
            "84a70085825820fd9a0bc89a2b0a6e4617fe361d18a0b31c6c2d6352013675598d5f9896c42e6c0082582073a0b7a80a107afd1b37ba61c579e6e0ff9063ce9812addfb50f602b4126016d018258200b94858a404cc6fc0d7f6a5eec3e1a0b6f4e66a9bea8ea90f0ec82d8cf6eea1a01825820e355edd62518193f8efd7d382193d0af34d4130c999be09485929fcbcb808509008258200e544cc9b26d36934942bbcf7430caa2d9c46d7e5fb58c02f31fa1e61586083f020184825839013bdd941f4f77fda1c7aa416de059347d4965f2035b02f22e1b31c321aabaf579c7ac3816cf53e44361796ac35bd0e37b87a5ee4dec93a29b1a0087a23782583901815f778a2ba10aa0fdc4acf1436e701f78d6f717361d4164c95dcfb77e9edebd75b1908b72519186c997cd98e6d62e5636f0e3aea1ee51401a000f424082583901ed49d9adbd06592290b9a16032375d6b79d4df760cad0d9bca9555fc4199f66b16ce9eb5849ed96473face025b2e9bcbdf1e352ad4362981821a00159282a1581ca02684b9ece84a4341585d2ae813163356ba0ca950091d1935bdb905a1514855534b59484f53544c455231353031330182583901ed49d9adbd06592290b9a16032375d6b79d4df760cad0d9bca9555fc4199f66b16ce9eb5849ed96473face025b2e9bcbdf1e352ad43629811a14ddc075021a0009ffd8031a0487ded1081a0487d02b0b5820337d35fe2968e6fbef26024418393574cf0f44839c59a49faa42f312c4e9f9200d81825820319c7d0b78c6ebc15246fcc53b4ed7cadfe1d53bb77034d38b38f22e6bc74c3e04a3038159125a5912570100003323322332233322232332232323332223332223333333322222222332233333222223333222233322233223322332233322233223322332233223322323232323232323232323232323232323232323232323232335500133355504875ceb403c03c44888888c01cccc010c01800cc014008c02000494cd4c0ac00441404d4120d4c13ccd5ce249025064000504988c8c8c8c8c8c8cccd5cd19b8735573aa00a90001280112803a4c26603aa002a0042600c6ae8540084c050d5d09aba25001135573ca00226ea80084d411d262323232323232323232323232323232323232323232323333573466e1cd55cea80aa40004a0044a02e93099999999998172800a8012801a8022802a8032803a8042804a805099a81080b1aba15012133502001635742a0202666aa032eb94060d5d0a8070999aa80c3ae501735742a018266a03a0426ae8540284cd4070cd54078085d69aba15008133501675a6ae8540184cd4069d71aba150041335019335501b75c0346ae8540084c080d5d09aba25001135744a00226ae8940044d5d1280089aba25001135744a00226ae8940044d5d1280089aba25001135573ca00226ea80084d41192623232323232323333573466e1cd55cea802a40004a0044a00e9309980fa800a8010980b9aba1500213005357426ae8940044d55cf280089baa0021350454988c8c8c8c8c8c8c8c8cccd5cd19b8735573aa00e90001280112804a4c2666044a002a004a006260106ae8540104ccd54029d728049aba15002133500775c6ae84d5d1280089aba25001135573ca00226ea80084d41112623232323232323333573466e1cd55cea802a40004a0044a00e93099810a800a8010980a1aba150021335005012357426ae8940044d55cf280089baa002135043498488c8c8c8c8c8c8cccd5cd19b87500448000940089401126135024500113006357426aae79400c4cccd5cd19b87500148008940889401126135573aa00226ea80084d410d261335500175ceb444888c8c8c004dd58019a80090008918009aa827111919191919191999aab9f0075504e25002053133504f50025001130063574400a266aa0a4a002a004260106aae7540084c018d55cf280089aba10011223232323232323333573466e1cd55cea802a40004a0044a00e93099a811a800a801099a8038031aba150021335007005357426ae8940044d55cf280089baa002135040498488c8c8c8c8c8c8cccd5cd19b8735573aa00a90001280112803a4c266a04ca002a004266a01000c6ae8540084c020d5d09aba25001135573ca00226ea80084d40fd261223232323232323333573466e1cd55cea802a40004a0044a00e93099a811a800a801099a8038031aba1500213007357426ae8940044d55cf280089baa00213503e498488c8c8c8c8c8c8c8cccd5cd19b87500548010940b0940092613333573466e1d4011200225002250044984d40ad40044c018d5d09aab9e500313333573466e1d4005200025029250044984d55cea80089baa00213503d4988c8c8c8cccd5cd19b875002480088090940092613333573466e1d400520002022250034984d55ce9baa00213503b498488c8c8c004dd60019a80090008918009aa823911999aab9f00125045233504430063574200460066ae88008118800444888c8c8c8c8c8c8cccd5cd19b8735573aa00a90001280112803a4c266aa092a002a0042600e6ae8540084c014d5d09aba25001135573ca00226ea80084d40e926232323232323232323232323232323333573466e1d4029200625002250044984c0c940044c038d5d09aab9e500b13333573466e1d401d200425002250044984c0b540044c030d5d09aab9e500813333573466e1d4011200225002250044984c0a540044c02cd5d09aab9e500513333573466e1d4005200025003250064984d55cea80189813a80089bae357426aae7940044dd500109a81ba4c4646464646464646464646464646464646464646464646464646666ae68cdc3a80aa401840884a0049309999ab9a3370ea028900510221280124c26666ae68cdc3a809a40104a0044a00c9309981f2800a80109bae35742a00426eb4d5d09aba25001135573ca02426666ae68cdc3a8072400c4a0044a00c9309981d2800a80109bae35742a00426eb8d5d09aba25001135573ca01a26666ae68cdc3a804a40084a0044a00c9309981ca800a801098069aba150021375c6ae84d5d1280089aab9e500813333573466e1d4011200225002250044984c0d540044c020d5d09aab9e500513333573466e1d4005200025003250064984d55cea80189817a800898021aba135573ca00226ea80084d40d92623232323232323232323232323333573466e1d4021200225002250084984ccc0e940054009400c4dd69aba150041375a6ae8540084dd69aba135744a00226ae8940044d55cf280289999ab9a3370ea0029000128019280324c26aae75400c4c0cd40044c010d5d09aab9e50011375400426a06a93119191919191919191999ab9a3370ea0089001128011280224c26070a00226eb8d5d09aab9e500513333573466e1d4005200025003250064984d55cea8018981aa80089bae357426aae7940044dd500109a81a24c46464646464646666ae68cdc39aab9d500548000940089401d26133028500150021300635742a00426eb4d5d09aba25001135573ca00226ea80084d40cd2623232323333573466e1cd55cea801240004a0044a0089309bae357426aae7940044dd500109a81924c4424660020060044002444444444424666666666600201601401201000e00c00a00800600440024424660020060044002444246660020080060044002442466002006004400224244600400622440022400224424660020060042400224424660020060042400224424660020060042400224400424400240022424446006008224440042244400224002424444600800a424444600600a424444600400a424444600200a40024424660020060044002424444444600e01044244444446600c012010424444444600a010244444440082444444400644244444446600401201044244444446600201201040024244600400644424466600200a008006400242446004006424460020064002222444464646464646464646666ae68cdc39aab9d500748000940089402526133355500e5001500250031300a35742a008260106ae8540084c018d5d09aba25001135744a00226aae7940044dd500109a802a4c24c222444246660020080060042224002224a00822440042442446600200800624002240024002224424660020060042240022246460020024466006600400400266466644466644466644466446644666444664466644464664466446666666644444444666644446644664466446644646464664464666664444466446464646464664464646644646464646466664444646466446464646464646464646464646464646464646464646644664464646400244446a607000244a6666a607800242c42c42c42646464a66a60c8010264a66a60ca6666aa604224002a08c0026a6aa0daa004440020ce2666601a01601400e6a6aa0daa0044400420cc440ce26601601200c2a66a6a0d060026a609400a44444444440142c44266aa0dc0040026a00240022460026aa0ee44a66a6a0d20022a0d64426a60c200444a66a60d060ce002266a0dc002600c0062600c006446a6aaa00800444464666aa603624002a00246601c6a60d400244660da004a0de660d660e800aa0da66aa60322400246a60c66a60b6002440024440066a608c00a444444444401426a02aa03c44446a600e0084446a6aaa01000c44464646464a66a60cc6602666a606e24002a004900019983519838983d003a83999a83619aa837a450033506c335506f4890033702a006a002a0daa0daa0e626602666a606e24002a004900119983519838983d005283999a83619aa837a4410033506c335506f489005001506d506d50731067133303b00800700513355303b12001235306800122233306c35307235306b0042220032233075002507700200135304b00a2222222222009133700006a0022a66a60c400226660766a60ca00e4440049110048810014800044488848ccc00401000c008444800488848ccc00401000c0088004894cd4c154cc00cd4c16000888800cd4c16000488800c54cd4c154ccc01c014d4c160008888008d4c1600048880084d4c1600088894cd4d419000484d4c1700148894cd4d41a000484cc04801400441744d4c16c0108894cd4d419c0048417441744158415888d4c17800888d4c18000c88c8cd4c1ac0148cd4c1b001094cd4c16cccd5cd19b8f00200105d05c15003105c205c2335306c004205c25335305b333573466e3c0080041741705400c417054cd4d419000c854cd4d419400884cc024008004416854cd4d419000484168416888cd4c1880088cd4c18c0088cc018008004888160888cd4c19401081608894cd4c164ccd5cd19b8700600305b05a153353059333573466e1c01400816c1684cc0240100044168416888ccd5cd19b87002001054053223353063002233530640022330080020012054233530640022054233008002001222333004233353550180012330054800000488cc0180080048cc01400520000020012223233355300d120013501d501b23535505a0012233355301012001500423535505d00122300a0010013300500300213501c501a22335530081200123535505700122335505a002333535501700123355300c1200123535505b00122335505e00235501e0010012233355500900800200123355300c1200123535505b00122335505e00235501c00100133355500400300200122333573466e3c00800413c138444888ccd54c04448005414ccd54c01c480048d4d5415800488cd54164008d54064004ccd54c0444800488d4d5415c008894cd4c144ccd54c03448004d402140448d4d5416800488cc028008014018400c4cd415c01000d4150004cd54c01c480048d4d5415800488c8c8cd5416c010c004018d4004800448c004d54198894cd4d41600044d54068010884d4d54174008894cd4c15ccc0340080244cd5407c0200044c01800c00848cd40b488ccd401400c008004d400800448d4d402c0048800448d4d402800488008d4004800448c004d5416c8844894cd4d413c00454144884cd4148c010008cd54c01848004010004d4004800448c004d5416488448c8894cd4d413c0044d4020010884cd4014c010008ccd54c020480040180100044d401800448d4d40940048800448d4d4090004880084cd400c004104894cd4c104008410c400448848cc00400c00848004d4004800448c004d5414488448894cd4d41180044008884cc014008ccd54c01c480040140100044484888c00c01044884888cc0080140104484888c0040104480044cd40180040e0894cd4c0dc008400440e048cd406088ccd401400c008004d400800448d4d400c0048800448d4d40080048800848848cc00400c00848004d4004800448c004d54110884894cd4c0ccccd5cd19b88001480000d40d04d4020d4c018cd5ce24810250390000749854cd4d40e00084d4020d4c018cd5ce2481025061000074988854cd4c0d4ccd5cd19b87003480000dc0d840084cd4c01848004004cdc0801a400424002400224c44464a66a605c666ae68cdc4801a8008180178a8008801899b8300100335001200112300135503e2211225335350320011503422133503530040023355300612001004001222323232300100635001200112300135504122335350330014800088d4d540e0008894cd4c0c8ccd5cd19b8f00200a034033130080011300600323232300100335001200112300135504122335350330014800088d4d540e0008894cd4c0c8ccd5cd19b8f002009034033100113006003221233001003002200121222230040052122223003005212222300200521222230010052001133500250045003122123300100300212001120011223355500300200111122230033002001222222222212333333333300100b00a0090080070060050040030022001122123300100300212001122123300100300212001122123300100300212001121222300300411222002112220011200121222222230070082212222222330060090082122222223005008122222220041222222200322122222223300200900822122222223300100900820012212330010030022001221233001003002200123530050012225335350110012100810061220021220012001222123330010040030022001112200212212233001004003120011122123300100300211200122123300100300220011212230020031122001120012122300200322212233300100500400320012122300200321223001003200111232300100122330033002002001332233300248811c815f778a2ba10aa0fdc4acf1436e701f78d6f717361d4164c95dcfb700481412080897a2221233300100400300220011049fd866820083581c3bdd941f4f77fda1c7aa416de059347d4965f2035b02f22e1b31c3211a007a1200d866820180ff0581840004d87a80821a0023c4c61a263addf6f5f6";

        final tx = CardanoTransaction.deserializeFromHex(input);

        const expectedBody =
            "a70085825820fd9a0bc89a2b0a6e4617fe361d18a0b31c6c2d6352013675598d5f9896c42e6c0082582073a0b7a80a107afd1b37ba61c579e6e0ff9063ce9812addfb50f602b4126016d018258200b94858a404cc6fc0d7f6a5eec3e1a0b6f4e66a9bea8ea90f0ec82d8cf6eea1a01825820e355edd62518193f8efd7d382193d0af34d4130c999be09485929fcbcb808509008258200e544cc9b26d36934942bbcf7430caa2d9c46d7e5fb58c02f31fa1e61586083f020184825839013bdd941f4f77fda1c7aa416de059347d4965f2035b02f22e1b31c321aabaf579c7ac3816cf53e44361796ac35bd0e37b87a5ee4dec93a29b1a0087a23782583901815f778a2ba10aa0fdc4acf1436e701f78d6f717361d4164c95dcfb77e9edebd75b1908b72519186c997cd98e6d62e5636f0e3aea1ee51401a000f424082583901ed49d9adbd06592290b9a16032375d6b79d4df760cad0d9bca9555fc4199f66b16ce9eb5849ed96473face025b2e9bcbdf1e352ad4362981821a00159282a1581ca02684b9ece84a4341585d2ae813163356ba0ca950091d1935bdb905a1514855534b59484f53544c455231353031330182583901ed49d9adbd06592290b9a16032375d6b79d4df760cad0d9bca9555fc4199f66b16ce9eb5849ed96473face025b2e9bcbdf1e352ad43629811a14ddc075021a0009ffd8031a0487ded1081a0487d02b0b5820337d35fe2968e6fbef26024418393574cf0f44839c59a49faa42f312c4e9f9200d81825820319c7d0b78c6ebc15246fcc53b4ed7cadfe1d53bb77034d38b38f22e6bc74c3e04";

        expect(cborEncode(tx.body.serialize(forJson: false)).hexEncode(), expectedBody);
        expect(tx.body.serializeAsBytes().hexEncode(), expectedBody);
        expect(tx.body.serializeHexString(), expectedBody);
      });
    });

    group("re-serialize", () {
      test("hex", () async {
        const expectedBody =
            "a70085825820fd9a0bc89a2b0a6e4617fe361d18a0b31c6c2d6352013675598d5f9896c42e6c0082582073a0b7a80a107afd1b37ba61c579e6e0ff9063ce9812addfb50f602b4126016d018258200b94858a404cc6fc0d7f6a5eec3e1a0b6f4e66a9bea8ea90f0ec82d8cf6eea1a01825820e355edd62518193f8efd7d382193d0af34d4130c999be09485929fcbcb808509008258200e544cc9b26d36934942bbcf7430caa2d9c46d7e5fb58c02f31fa1e61586083f020184825839013bdd941f4f77fda1c7aa416de059347d4965f2035b02f22e1b31c321aabaf579c7ac3816cf53e44361796ac35bd0e37b87a5ee4dec93a29b1a0087a23782583901815f778a2ba10aa0fdc4acf1436e701f78d6f717361d4164c95dcfb77e9edebd75b1908b72519186c997cd98e6d62e5636f0e3aea1ee51401a000f424082583901ed49d9adbd06592290b9a16032375d6b79d4df760cad0d9bca9555fc4199f66b16ce9eb5849ed96473face025b2e9bcbdf1e352ad4362981821a00159282a1581ca02684b9ece84a4341585d2ae813163356ba0ca950091d1935bdb905a1514855534b59484f53544c455231353031330182583901ed49d9adbd06592290b9a16032375d6b79d4df760cad0d9bca9555fc4199f66b16ce9eb5849ed96473face025b2e9bcbdf1e352ad43629811a14ddc075021a0009ffd8031a0487ded1081a0487d02b0b5820337d35fe2968e6fbef26024418393574cf0f44839c59a49faa42f312c4e9f9200d81825820319c7d0b78c6ebc15246fcc53b4ed7cadfe1d53bb77034d38b38f22e6bc74c3e04";

        final body = CardanoTransactionBody.deserializeHex(expectedBody);

        expect(cborEncode(body.serialize(forJson: false)).hexEncode(), expectedBody);
        expect(body.serializeAsBytes().hexEncode(), expectedBody);
        expect(body.serializeHexString(), expectedBody);
      });

      test("empty metadataHash is preserved during re-serialization", () {
        // CBOR: a4 (map 4) 00 d9010280 (key 0: inputs with tag 258, empty) 01 80 (key 1: outputs, empty)
        //       02 182a (key 2: fee = 42) 07 40 (key 7: metadataHash = empty bytes)
        // This tests that an empty metadataHash (0x40 = empty bytes) is NOT dropped during re-serialization
        const bodyWithEmptyMetadataHash = "a400d9010280018002182a0740";

        final body = CardanoTransactionBody.deserializeHex(bodyWithEmptyMetadataHash);

        // Verify metadataHash was parsed as empty (not null)
        expect(
          body.metadataHash,
          isNotNull,
          reason: "Empty metadataHash should be parsed as empty Uint8List, not null",
        );
        expect(body.metadataHash!.isEmpty, isTrue, reason: "metadataHash should be empty");

        // Re-serialize and verify exact byte match - this will fail if isNotEmpty check drops the empty metadataHash
        expect(
          body.serializeHexString(),
          bodyWithEmptyMetadataHash,
          reason: "Empty metadataHash must be preserved during re-serialization",
        );
      });

      test("copyWith on ascending-order body preserves ascending order when adding new field", () {
        // CBOR: a4 (map 4) with keys 0, 1, 2, 8 in ascending order (with gap at 3-7)
        // 00 d9010280 (key 0: inputs)
        // 01 80 (key 1: outputs)  
        // 02 182a (key 2: fee = 42)
        // 08 1903e8 (key 8: validityStartInterval = 1000)
        const bodyWithAscendingKeys = "a400d9010280018002182a081903e8";

        final body = CardanoTransactionBody.deserializeHex(bodyWithAscendingKeys);

        // Use copyWith to add ttl (key 3), which should come BETWEEN key 2 and key 8
        final modifiedBody = body.copyWith(ttl: BigInt.from(5000));

        // The serialized output MUST have ascending key order: 0, 1, 2, 3, 8
        // NOT broken order: 0, 1, 2, 8, 3 (which would happen if 3 is appended)
        final serialized = modifiedBody.serialize(forJson: false);
        final keys = serialized.keys.map((k) => (k as CborSmallInt).toInt()).toList();

        expect(
          keys,
          equals([0, 1, 2, 3, 8]),
          reason: "Adding a new field via copyWith on ascending-order body must preserve ascending order",
        );
      });
    });
  });
}
